/*
AjaxEsSio v0.0.1
Seamless Socket.IO/WebSocket with EventSource and AJAX long polling fallbacks.
http://bhittani.com/javascript/ajaxessio

Copyright (c) 2015 M. Kamal Khan <shout@bhittani.com>

The MIT License (MIT)
*/
(function(){function t(){function t(t,e){s.then="reject"===t?function(t,n){n(e)}:function(t){t(e)},s.resolve=s.reject=function(){throw new Error("Promise already completed")};for(var n,i=0;n=o[i++];)n[t]&&n[t](e);o=null}function e(e){t("resolve",e)}function n(e){t("reject",e)}function i(t,e){o.push({resolve:t,reject:e})}var o=[],s={resolve:e,reject:n,then:i,safe:{then:function(t,e){s.then(t,e)}}};return s}var n,i,o;n={open:!1,open:function(){var e;return e=new t,this.open||(this.open=!0),e.resolve(),e},close:function(){var e;return e=new t,this.open&&(this.open=!1),e.resolve(),e},emit:function(t){return this._errors(t,"emit"),this._ajax("POST",this.__namespace,this.__data,this._callbacks(t)),this._reset(),this},"do":function(t){return this._errors(t,this.__once?"once":"do"),this._ajax("GET",this.__namespace,this.__data,this._callbacks(t)),this._reset(),this},once:function(t){return this.__once=!0,this["do"](t)}},i={es:null,open:function(){var n;return n=new t,this.es=new EventSource(this.path),this.es.addEventListener("open",function(t){return function(){return n.resolve(),t.es.addEventListener("error",function(t){return null!=callbacks.fail?callbacks.fail(e.toString()):void 0})}}(this)),n},close:function(){var e;return e=new t,this.es.close(),e.resolve(),e},emit:function(t){return this._errors(t,"emit"),this._ajax("POST",this.__namespace,this.__data,this._callbacks(t)),this._reset(),this},"do":function(t){var e;return this._errors(t,"do"),e=this._callbacks(t),this.es.addEventListener(this.__namespace,function(t){return function(n){var i,o,s;o=n.data,s=t.args.response;try{"json"===s?o=t._json(o):"xml"===s&&(o=t._xml(o))}catch(r){return i=r,null!=e.fail&&e.fail(i.toString()),-1}return null!=e.done?e.done(o):void 0}}(this)),this._reset(),this},once:function(t){return this["do"](t)}},o={socket:null,open:function(){var e,n;return e=new t,n=this.path,this.port&&(n=this.path+":"+this.port),this.socket=new io(n,{forceNew:!0}),this.socket.on("connect",function(){return e.resolve()}),e},close:function(){var e;return e=new t,this.socket.close(),e.resolve(),e},emit:function(t){var e;return this._errors(t,"emit"),e=this._callbacks(t),this.socket.emit(this.__namespace,this.__data,function(t){return null!=e.done?e.done(t):void 0}),this._reset(),this},"do":function(t){var e;return this._errors(t,"do"),e=this._callbacks(t),this.socket.on(this.__namespace,function(t){return null!=e.done?e.done(t):void 0}),this._reset(),this},once:function(t){var e;return this._errors(t,"once"),e=this._callbacks(t),this.socket.once(this.__namespace,function(t){return null!=e.done?e.done(t):void 0}),this._reset(),this}},window.ajaxessio=function(){function t(e,s,r){if(this.type=e,this.path=s,"ajax"===e)this.args={response:"json",timeout:3e4},r&&"response"in r&&(this.args.response=r.response),r&&"timeout"in r&&(this.args.timeout=r.timeout),t.include(n);else if("es"===e)this.args={response:"json"},r&&"response"in r&&(this.args.response=r.response),t.include(i);else{if("sio"!==e)throw{name:"Invalid connection type",message:'type should either be "ajax" for long polling, "es" for EventSource or "sio" Socket.IO/WebSockets',toString:function(){return this.name+":"+this.message}};this.port=r||!1,t.include(o)}}return t.prototype.__fail=null,t.prototype.__namespace=null,t.prototype.__data=[],t.prototype.__delay=250,t.prototype.__once=!1,t.prototype._isEmpty=function(t){var e;if("object"==typeof t)for(e in t)return!1;return null!=t&&t},t.prototype._errors=function(t,e){if(null==e&&(e="do"),null===this.__namespace)throw{name:"No route defined",message:'route should be set by calling .route("namespace")',toString:function(){return this.name+":"+this.message}};if("emit"===e&&this._isEmpty(this.__data))throw{name:"No data found",message:"empty data can not be sent. Set data by calling .with([object])",toString:function(){return this.name+":"+this.message}};if(this.__fail&&"function"!=typeof this.__fail)throw{name:"Error callback invalid",message:"error should be set by calling .error([function])",toString:function(){return this.name+":"+this.message}};if(this.__fail&&"function"!=typeof this.__fail)throw{name:"Error callback invalid",message:"error should be set by calling .error([function])",toString:function(){return this.name+":"+this.message}};if(this.__fail&&"function"!=typeof this.__fail)throw{name:"Error callback invalid",message:"error should be set by calling .error([function])",toString:function(){return this.name+":"+this.message}};if(t&&"function"!=typeof t)throw{name:"Success callback invalid",message:"success callback should be set by calling ."+e+"([function])",toString:function(){return this.name+":"+this.message}}},t.prototype._callbacks=function(t){var e;return e={},"function"==typeof this.__fail&&(e.fail=this.__fail),"function"==typeof t&&(e.done=t),e},t.prototype._reset=function(){return this.__fail=null,this.__namespace=null,this.__data=[],this.__delay=250,this.__once=!1},t.prototype._xml=function(t){var e;if(null!=window.DOMParser)return e=new window.DOMParser,e.parseFromString(t.trim(),"text/xml");if(null!=window.ActiveXObject&&(e=new window.ActiveXObject("Microsoft.XMLDOM")))return e.async="false",e.loadXML(t.trim()),e;throw{name:"XML Parser not available",message:"this browser does not support XML parsing.",toString:function(){return this.name+":"+this.message}}},t.prototype._json=function(t){var e,n;try{e=JSON.parse(t.trim())}catch(i){throw n=i,{name:"Invalid json or url/route",message:"the json response was invalid. "+n,toString:function(){return this.name+":"+this.message}}}return e},t.prototype._ajax=function(t,e,n,i,o){var s,r,a,u,c,l,h,f;if(null==o&&(o=!1),!o&&!this.open)return-1;if(u=!0,null!=window.XMLHttpRequest&&(f=new XMLHttpRequest),null==window.XMLHttpRequest&&(f=new ActiveXObject("Microsoft.XMLHTTP")),f.onreadystatechange=function(s){return function(){var r,a,c,l,h;if(!o&&!s.open)return f.abort(),-1;if(4===f.readyState){if(l=f.response||f.responseText,!l)return f.abort(),-1;h="text",r=s.args.response?s.args.response.toLowerCase():f.getResponseHeader("Content-Type").toLowerCase();try{r.indexOf(!1)?(l=s._json(l),h="json"):r.indexOf(!1)&&(l=s._xml(l),h="xml")}catch(p){return a=p,null!=i.fail&&i.fail(a.toString()),f.abort(),-1}if(200>=(c=f.status)&&300>c||304===f.status?(s.__once&&!s._isEmpty(l)&&(u=!1),s._isEmpty(l)||null==i.done||i.done(l,f.status,f.statusText,f)):null!=i.fail&&i.fail(l,f.status,f.statusText,f),f.abort(),"GET"===t&&u)return setTimeout(function(){return s._ajax(t,e,n,i)},s.__delay)}}}(this),c=[],c=function(){var t;t=[];for(a in n)h=n[a],h="function"==typeof h?h():h,t.push(encodeURIComponent(a)+"="+encodeURIComponent(h));return t}(),"GET"===t){s=document.createElement("a"),s.href=this.path,l=""!==s.search?"&":"?",c=c.length?l+c.join("&"):"",f.open(t,""+this.path+e+c,!0),f.timeout=this.args.timeout;try{f.send(null)}catch(p){r=p}}else if("POST"===t){f.open(t,""+this.path+e,!0),f.timeout=this.args.timeout,f.setRequestHeader("Content-type","application/x-www-form-urlencoded");try{f.send(c.join("&"))}catch(p){r=p}}return f.ontimeout=function(o){return function(){return"GET"===t&&u?setTimeout(function(){return o._ajax(t,e,n,i)},o.__delay):void 0}}(this),f},t.prototype.route=function(t){return this.__namespace=t,this},t.prototype["with"]=function(t){return this.__data=t,this},t.prototype.error=function(t){return this.__fail=t,this},t.prototype.delay=function(t){return!isNaN(t)&&function(t){return(0|t)===t}(parseFloat(t))&&(this.__delay=parseInt(t)),this},t.include=function(t){var e,n,i;for(e in t)i=t[e],"included"!==e&&(this.prototype[e]=i);return null!=(n=t.included)&&n.apply(this),this},t}(),"function"==typeof window.define&&window.define.amd&&window.define("ajaxessio",[],function(){return window.ajaxessio})}).call(this);
